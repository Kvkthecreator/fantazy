"""Session Evaluation models.

Evaluations are "reports" generated by Director at episode completion.
They represent shareable results like flirt archetype, mystery summary, etc.

Reference: docs/DIRECTOR_ARCHITECTURE.md, docs/plans/FLIRT_TEST_IMPLEMENTATION_PLAN.md
"""

import json
import secrets
import string
from datetime import datetime
from typing import Any, Dict, List, Optional
from uuid import UUID

from pydantic import BaseModel, Field, field_validator


class EvaluationType:
    """Evaluation type constants."""
    FLIRT_ARCHETYPE = "flirt_archetype"
    ROMANTIC_TROPE = "romantic_trope"  # Play Mode v2
    MYSTERY_SUMMARY = "mystery_summary"
    COMPATIBILITY = "compatibility"
    EPISODE_SUMMARY = "episode_summary"


class FlirtArchetype:
    """Flirt archetype constants (per implementation plan)."""
    TENSION_BUILDER = "tension_builder"
    BOLD_MOVER = "bold_mover"
    PLAYFUL_TEASE = "playful_tease"
    SLOW_BURN = "slow_burn"
    MYSTERIOUS_ALLURE = "mysterious_allure"


class RomanticTrope:
    """Romantic trope constants for Play Mode v2."""
    SLOW_BURN = "slow_burn"
    SECOND_CHANCE = "second_chance"
    ALL_IN = "all_in"
    PUSH_PULL = "push_pull"
    SLOW_REVEAL = "slow_reveal"


# Romantic Trope metadata for display and evaluation
# UNHINGED EDITION - maximum virality, MBTI energy, share-worthy
ROMANTIC_TROPES = {
    RomanticTrope.SLOW_BURN: {
        "title": "SLOW BURN",
        "tagline": "the tension is the whole point and you know it",
        "description": "You'd rather wait three seasons for a kiss than rush it. You've said \"I just think it's better when it builds\" at least once this month. Eye contact across a room? That's your whole love language. You're not playing hard to get — you genuinely believe anticipation is the best part. Other people think you're patient. You know you're just savoring it.",
        "callback_format": "You told {character}: \"{quote}\" ...yeah, we clocked you immediately.",
        "share_text": "I'm a SLOW BURN — the tension is the whole point. what's yours?",
        "signals": ["comfortable_silence", "deep_questions", "patient_pacing", "layered_revelation"],
        "your_people": ["darcy & elizabeth", "jim & pam", "connell & marianne"],
    },
    RomanticTrope.SECOND_CHANCE: {
        "title": "SECOND CHANCE",
        "tagline": "you never really closed that chapter, did you",
        "description": "You still think about the one that got away. Not in a sad way — in a \"the timing was just wrong\" way. You believe some people are meant to find their way back to each other. Reunion episodes are your weakness. You've definitely stalked an ex's Instagram \"just to see how they're doing.\" You're not hung up on the past — you just think some stories deserve a second draft.",
        "callback_format": "You told {character}: \"{quote}\" ...you're already writing the sequel in your head.",
        "share_text": "I'm a SECOND CHANCE — some stories deserve a sequel. what's yours?",
        "signals": ["past_callbacks", "growth_acknowledgment", "timing_awareness", "hopeful_realism"],
        "your_people": ["mia & sebastian", "noah & allie", "jesse & céline"],
    },
    RomanticTrope.ALL_IN: {
        "title": "ALL IN",
        "tagline": "when you know, you know — and you KNEW",
        "description": "You don't do slow. You don't do games. When you feel it, you say it, and honestly? That's terrifying to most people. You've been called \"intense\" like it's a bad thing. It's not. You'd rather be rejected for being honest than liked for being careful. While everyone else is calculating their next move, you already made yours. Life's too short to pretend you don't care.",
        "callback_format": "You told {character}: \"{quote}\" ...no hesitation. respect.",
        "share_text": "I'm ALL IN — when I know, I know. what's yours?",
        "signals": ["direct_expression", "confident_moves", "emotional_clarity", "bold_honesty"],
        "your_people": ["rachel & nick", "lara jean & peter", "jake & amy"],
    },
    RomanticTrope.PUSH_PULL: {
        "title": "PUSH & PULL",
        "tagline": "you want them to work for it (and you'll work for it too)",
        "description": "Hot then cold. Close then distant. It's not games — it's tension, and you're fluent in it. You flirt by arguing. You show love by teasing. The chase is half the fun and you refuse to apologize for it. People say they want straightforward, but they keep coming back to you. You're exhausting in the best way. Boring could never be your problem.",
        "callback_format": "You told {character}: \"{quote}\" ...push, pull, we see you.",
        "share_text": "I'm a PUSH & PULL — the chase is half the fun. what's yours?",
        "signals": ["playful_resistance", "witty_deflection", "tension_maintenance", "strategic_vulnerability"],
        "your_people": ["kat & patrick", "jess & nick", "lorelai & luke"],
    },
    RomanticTrope.SLOW_REVEAL: {
        "title": "SLOW REVEAL",
        "tagline": "they have to earn the real you",
        "description": "You're not cold — you're careful. There's a version of you that most people get, and then there's the version that only comes out when someone proves they're paying attention. You test people without them knowing. You reward curiosity and punish assumptions. People call you \"mysterious\" and you let them, because explaining yourself sounds exhausting. The right person will figure it out.",
        "callback_format": "You told {character}: \"{quote}\" ...you let that one slip, didn't you.",
        "share_text": "I'm a SLOW REVEAL — you have to earn the real me. what's yours?",
        "signals": ["selective_sharing", "intriguing_deflection", "earned_intimacy", "mysterious_allure"],
        "your_people": ["jane & rochester", "fleabag & the priest", "bella & edward"],
    },
}


# Archetype metadata for display
FLIRT_ARCHETYPES = {
    FlirtArchetype.TENSION_BUILDER: {
        "title": "The Tension Builder",
        "description": "You know exactly when to pause, when to hold back, when to let anticipation do the work.",
        "signals": ["pause_mastery", "anticipation_building", "comfortable_silence"],
    },
    FlirtArchetype.BOLD_MOVER: {
        "title": "The Bold Mover",
        "description": "Direct, confident, you say what you want. No games, just magnetic clarity.",
        "signals": ["direct_expression", "confident_initiation", "clear_interest"],
    },
    FlirtArchetype.PLAYFUL_TEASE: {
        "title": "The Playful Tease",
        "description": "Light, fun, and impossible to pin down. You keep it breezy and leave them smiling.",
        "signals": ["humor_usage", "playful_banter", "light_energy"],
    },
    FlirtArchetype.SLOW_BURN: {
        "title": "The Slow Burn",
        "description": "Patient and deliberate, you build connection layer by layer. Depth over speed.",
        "signals": ["deep_questions", "genuine_curiosity", "patient_pacing"],
    },
    FlirtArchetype.MYSTERIOUS_ALLURE: {
        "title": "The Mysterious Allure",
        "description": "Intriguing and elusive, you reveal just enough to leave them wanting more.",
        "signals": ["selective_sharing", "intriguing_deflection", "magnetic_mystery"],
    },
}


def generate_share_id(length: int = 8) -> str:
    """Generate URL-safe share ID."""
    alphabet = string.ascii_lowercase + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(length))


class FlirtArchetypeResult(BaseModel):
    """Structured result for flirt archetype evaluation."""
    archetype: str
    confidence: float = Field(..., ge=0.0, le=1.0)
    primary_signals: List[str] = Field(default_factory=list)
    title: str
    description: str

    @classmethod
    def from_archetype(cls, archetype: str, confidence: float, signals: List[str]) -> "FlirtArchetypeResult":
        """Create result from archetype key."""
        metadata = FLIRT_ARCHETYPES.get(archetype, FLIRT_ARCHETYPES[FlirtArchetype.PLAYFUL_TEASE])
        return cls(
            archetype=archetype,
            confidence=confidence,
            primary_signals=signals,
            title=metadata["title"],
            description=metadata["description"],
        )


class RomanticTropeResult(BaseModel):
    """Structured result for romantic trope evaluation (Play Mode v2).

    Enhanced with personalization fields for shareable results:
    - evidence: 3 specific observations about user's romantic style
    - callback_quote: User's most trope-defining moment from conversation
    - cultural_refs: Pop culture examples of this trope
    """
    trope: str
    confidence: float = Field(..., ge=0.0, le=1.0)
    primary_signals: List[str] = Field(default_factory=list)
    title: str
    tagline: str
    description: str
    # Personalization fields (LLM-generated)
    evidence: List[str] = Field(default_factory=list)  # 3 observations
    callback_quote: Optional[str] = None  # User's defining moment
    # Static cultural references
    cultural_refs: List[tuple] = Field(default_factory=list)

    @classmethod
    def from_trope(
        cls,
        trope: str,
        confidence: float,
        signals: List[str],
        evidence: Optional[List[str]] = None,
        callback_quote: Optional[str] = None,
    ) -> "RomanticTropeResult":
        """Create result from trope key with optional personalization."""
        metadata = ROMANTIC_TROPES.get(trope, ROMANTIC_TROPES[RomanticTrope.SLOW_BURN])
        return cls(
            trope=trope,
            confidence=confidence,
            primary_signals=signals,
            title=metadata["title"],
            tagline=metadata["tagline"],
            description=metadata["description"],
            evidence=evidence or [],
            callback_quote=callback_quote,
            cultural_refs=metadata["cultural_refs"],
        )


class SessionEvaluation(BaseModel):
    """Session evaluation model - shareable result.

    Created by Director when an episode completes.
    Contains the evaluation result and share infrastructure.
    """
    id: UUID
    session_id: UUID

    # Evaluation identity
    evaluation_type: str

    # The evaluation result (schema depends on type)
    result: Dict[str, Any] = Field(default_factory=dict)

    # Share infrastructure
    share_id: Optional[str] = None
    share_count: int = 0

    # LLM tracking
    model_used: Optional[str] = None

    # Timestamp
    created_at: datetime

    @field_validator("result", mode="before")
    @classmethod
    def ensure_result_is_dict(cls, v: Any) -> Dict[str, Any]:
        """Handle result as JSON string (from DB)."""
        if v is None:
            return {}
        if isinstance(v, dict):
            return v
        if isinstance(v, str):
            try:
                parsed = json.loads(v)
                if isinstance(parsed, dict):
                    return parsed
            except (json.JSONDecodeError, TypeError):
                return {"raw": v}
        return {}

    class Config:
        from_attributes = True

    def get_flirt_result(self) -> Optional[FlirtArchetypeResult]:
        """Parse result as FlirtArchetypeResult if applicable."""
        if self.evaluation_type != EvaluationType.FLIRT_ARCHETYPE:
            return None
        return FlirtArchetypeResult(**self.result)

    def get_trope_result(self) -> Optional[RomanticTropeResult]:
        """Parse result as RomanticTropeResult if applicable."""
        if self.evaluation_type != EvaluationType.ROMANTIC_TROPE:
            return None
        return RomanticTropeResult(**self.result)


class SessionEvaluationCreate(BaseModel):
    """Input for creating a session evaluation."""
    session_id: UUID
    evaluation_type: str
    result: Dict[str, Any]
    model_used: Optional[str] = None
    generate_share_id: bool = True  # Whether to generate a share_id


class SessionEvaluationSummary(BaseModel):
    """Minimal evaluation info for lists and share pages."""
    id: UUID
    evaluation_type: str
    result: Dict[str, Any]
    share_id: Optional[str] = None
    share_count: int = 0
    created_at: datetime


class ShareableResult(BaseModel):
    """Public-facing shareable result (for share pages).

    Contains only what's needed for the share page display.
    Does not expose session_id or other internal details.
    """
    evaluation_type: str
    result: Dict[str, Any]
    share_id: str
    share_count: int
    created_at: datetime

    # Optional: character info for "continue with character" CTA
    character_name: Optional[str] = None
    character_id: Optional[UUID] = None
    series_id: Optional[UUID] = None
